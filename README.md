# Sui Swap Example

## Requirements

In the current branch `fixed-exchange-rate`, we implement a one-way exchange "pool" (`TokenPair`). 

Users can exchange Token X at a fixed rate to get Token Y. 
The reserve of Token Y in the pool is deposited by specific users in advance. 
Then users can exchange Token X at a fixed exchange rate to get Token Y. 
If the reserve of Token Y is insufficient, the exchange fails.

The token pair has "exchange rate numerator" and "exchange rate denominator" properties to indicate the exchange rate of Token X to Token Y.

* Anyone can create a token pair (pool).
* the `LiquidityToken` degenerates into a capability object. The account who owns it is the owner of the token pair.
* The "pool owner" can add Token Y reserves, withdraw Token X reserves, and withdraw Token Y reserves. 
    There are no operations for "adding liquidity", "removing liquidity", etc. 
* There are only `SwapX` for "normal users", no `SwapY` operation.


## Prerequisites

Here, let's try to develop it using the [dddappp](https://www.dddappp.org) low-code tool.

Currently, the dddappp low-code tool is published as a Docker image for developers to experience.

So before getting started, you need to:

* Install [Sui](https://docs.sui.io/build/install).

* Install [Docker](https://docs.docker.com/engine/install/).

* (Optional) Install MySQL database server if you want to test the off-chain service. The off-chain service generated by the tool currently use MySQL by default.

* (Optional) Install JDK and Maven if you want to test the off-chain service. The off-chain services generated by the tool currently use Java.

If you have already installed Docker, you can use Docker to run a MySQL database service. For example:

```shell
sudo docker run -p 3306:3306 --name mysql \
-v ~/docker/mysql/conf:/etc/mysql \
-v ~/docker/mysql/logs:/var/log/mysql \
-v ~/docker/mysql/data:/var/lib/mysql \
-e MYSQL_ROOT_PASSWORD=123456 \
-d mysql:5.7
```

## Programming

### Write DDDML model file

In the `dddml` directory in the root of the repository, create a DDDML file like [this](./dddml/swap.yaml).

> **Tip**
>
> About DDDML, here is an introductory article: ["Introducing DDDML: The Key to Low-Code Development for Decentralized Applications"](https://github.com/wubuku/Dapp-LCDP-Demo/blob/main/IntroducingDDDML.md).

There is one thing worth noting: why do we use property names like `X_Amount` in DDDML files.

Java Bean, in a way, can't handle property names like `XAmount` "correctly" - that is,
cases where one of the components of the property name is a "single letter".
To get around this problem, we decided to use property names like `X_Amount` instead of `XAmount`.

### Run dddappp project creation tool

#### Update dddappp Docker image

Since the dddappp v0.0.1 image is updated frequently, you may be required to manually delete the image and pull it again before `docker run`.

```shell
# If you have already run it, you may need to Clean Up Exited Docker Containers first
docker rm $(docker ps -aq --filter "ancestor=wubuku/dddappp:0.0.1")
# remove the image
docker image rm wubuku/dddappp:0.0.1
# pull the image
git pull wubuku/dddappp:0.0.1
```

---

In repository root directory, run:

```shell
docker run \
-v .:/myapp \
wubuku/dddappp:0.0.1 \
--dddmlDirectoryPath /myapp/dddml \
--boundedContextName Test.SuiSwapExample \
--suiMoveProjectDirectoryPath /myapp/sui-contracts \
--boundedContextSuiPackageName sui_swap_example \
--boundedContextJavaPackageName org.test.suiswapexample \
--javaProjectsDirectoryPath /myapp/sui-java-service \
--javaProjectNamePrefix suiswapexample \
--pomGroupId test.suiswapexample
```

The command parameters above are straightforward:

* This line `-v .:/myapp \` indicates mounting the local current directory into the `/myapp` directory inside the container.
* `dddmlDirectoryPath` is the directory where the DDDML model files are located. It should be a directory path that can be read in the container.
* Understand the value of the `boundedContextName` parameter as the name of the application you want to develop. When the name has multiple parts, separate them with dots and use the PascalCase naming convention for each part. Bounded-context is a term in Domain-driven design (DDD) that refers to a specific problem domain scope that contains specific business boundaries, constraints, and language. If you cannot understand this concept for the time being, it is not a big deal.
* `boundedContextJavaPackageName` is the Java package name of the off-chain service. According to Java naming conventions, it should be all lowercase and the parts should be separated by dots.
* `boundedContextSuiPackageName` is the package name of the on-chain Sui contracts. According to the Sui development convention, it should be named in snake_case style with all lowercase letters.
* `javaProjectsDirectoryPath` is the directory path where the off-chain service code is placed. The off-chain service consists of multiple modules (projects). It should be a readable and writable directory path in the container.
* `javaProjectNamePrefix` is the name prefix of each module of the off-chain service. It is recommended to use an all-lowercase name.
* `pomGroupId` is the GroupId of the off-chain service. We use Maven as the project management tool for off-chain service. It should be all lowercase and the parts should be separated by dots.
* `suiMoveProjectDirectoryPath` is the directory path where the on-chain Sui contract code is placed. It should be a readable and writable directory path in the container.

After the above command is successfully executed, two directories `sui-java-service` and `sui-contracts` should be added to the local current directory.


### Implementing business logic

The tool has generated some files with the suffix `_logic.move` in the directory `sui-contracts/sources`.

Generally, these files contain the scaffolding code of functions that implement business logic,
namely the signature part of the functions.
You just need to fill in the implementation part of the functions.

[TBD]

---

In [the model file](./dddml/swap.yaml), we defined some methods which use `Balance`, a resource type, as type of parameters or return values.
This makes these methods very combinable - as a developer of Move, a "resource-oriented programming" language,
you will already know this.

However, it's not easy to call them directly from clients.
So, we added this file [token_pair_service.move](./sui-contracts/sources/token_pair_service.move).
In this file, some entry functions are provided to facilitate clients to use the corresponding features directly.

That's the whole programming routine, isn't it simple?

## Test Application

### Deploy contract

Execute the following command in the directory `sui-contracts` to publish the contracts on chain:

```shell
sui client publish --gas-budget 600000000 --skip-fetch-latest-git-deps --skip-dependency-verification
```

If the command is executed successfully, the transaction digest of this publication will be output. For example:

```text
Transaction Digest: 4xBp37rDzUCdmLd9irvLmdmQ5uj2gED71U2gcQNe9nF5

│  │ ObjectID: 0x9816adcf7d885d2ef256f4c56a92fcbeafa08eea80e7318ed1d7bd8eff48a34b
│  │ Sender: 0xfc50aa2363f3b3c5d80631cae512ec51a8ba94080500a981f4ae1a2ce4d201c2
│  │ Owner: Shared
│  │ ObjectType: 0x01ea5b35865b62e25a1b3528260939282e819040563ee902716a3985b16b619c::exchange::Exchange
```

Take note of this transaction digest, for example, `4xBp37rDzUCdmLd9irvLmdmQ5uj2gED71U2gcQNe9nF5`.
When setting up the off-chain service, we will need it.


### Some preparations might be needed

We may need to mint ourselves some test coins first.

Included in this repository is a Move file (`example_coin.move`) that is needed to deploy a test coin (`EXAMPLE_COIN`).
You can create a separate Move project for it and deploy it.

Note that the first argument that needs to be passed to mint test coin is the ID of an object of type `0x0000..0002::coin::TreasuryCap`.
You can find it in the output message of the terminal when you deploy the contract.

```text
│  │ ObjectID: 0x8acf276b4542b7bd59eacd0307d971a4da95840d93f7451e8d8b242ca8dfda22
│  │ ObjectType: 0x2::coin::TreasuryCap<0x4bacff79c102805e6a1f0980456ecd5cd5e50dc155a90123de41e348e3ae07f0::example_coin::EXAMPLE_COIN>
```

Let's say the package ID of the test coin contract we deployed is `0x4bacff79c102805e6a1f0980456ecd5cd5e50dc155a90123de41e348e3ae07f0`.
Then, mint yourself some test coins like the following:

```shell
sui client call --package 0x4bacff79c102805e6a1f0980456ecd5cd5e50dc155a90123de41e348e3ae07f0 --module example_coin --function mint \
--args 0x8acf276b4542b7bd59eacd0307d971a4da95840d93f7451e8d8b242ca8dfda22 100000000000 --gas-budget 30000000
```

The output contains something like the following:

```text
│ Created Objects:                                                                                                                       │
│  ┌──                                                                                                                                   │
│  │ ObjectID: 0xea38ba6edde8b115d4f2dd79afee9e71496bae7d583cad4143943c875c19f036                                                        │
│  │ Sender: 0xfc50aa2363f3b3c5d80631cae512ec51a8ba94080500a981f4ae1a2ce4d201c2                                                          │
│  │ Owner: Account Address ( 0xfc50aa2363f3b3c5d80631cae512ec51a8ba94080500a981f4ae1a2ce4d201c2 )                                       │
│  │ ObjectType: 0x2::coin::Coin<0x4bacff79c102805e6a1f0980456ecd5cd5e50dc155a90123de41e348e3ae07f0::example_coin::EXAMPLE_COIN>         │
```

Record the ID of the test coin object created, for example `0xea38ba6edde8b115d4f2dd79afee9e71496bae7d583cad4143943c875c19f036`:

View the Sui coin objects in the current account:

```shell
sui client gas
```

If you have only one SUI coin object in your account, you can transfer some SUI to your account first to split this SUI coin object.
In the following test, we need to use a SUI coin object to add liquidity in addition to a SUI coin object to pay gas fee:

```shell
sui client pay-sui --input-coins 0x44e677e7fbfebef80d484eca63e350a1e8d9d5da4ab5a1e757d7e22a2d0a7b2c --amounts 1000000000 \
--recipients 0xfc50aa2363f3b3c5d80631cae512ec51a8ba94080500a981f4ae1a2ce4d201c2 --gas-budget 30000000
```

### Initialize token pair

Note the arguments required by "initialize token pair" function, which are assumed by the following commands:

* `exchange: &mut Exchange`: Assuming the ID of the `Exchange` object is `0x9816adcf7d885d2ef256f4c56a92fcbeafa08eea80e7318ed1d7bd8eff48a34b`.
* `y_coin: Coin<Y>`: Assuming the SUI coin object ID is `0x44e677e7fbfebef80d484eca63e350a1e8d9d5da4ab5a1e757d7e22a2d0a7b2c`.
* `y_amount: u64`: `1000000`.
* `exchange_rate_numerator: u64`: `1`.
* `exchange_rate_denominator: u64`: `100`.

So, the command that needs to be executed is similar to the following:

```shell
sui client call --package 0x01ea5b35865b62e25a1b3528260939282e819040563ee902716a3985b16b619c --module token_pair_service --function initialize_token_pair \
--type-args '0x4bacff79c102805e6a1f0980456ecd5cd5e50dc155a90123de41e348e3ae07f0::example_coin::EXAMPLE_COIN' '0x2::sui::SUI' \
--args \
'0x9816adcf7d885d2ef256f4c56a92fcbeafa08eea80e7318ed1d7bd8eff48a34b' \
'0x44e677e7fbfebef80d484eca63e350a1e8d9d5da4ab5a1e757d7e22a2d0a7b2c' \
'"1000000"' \
'"1"' \
'"100"' \
--gas-budget 30000000
```

Note the IDs of the created `TokenPair` object and `LiquidityToken` object:

```text
│  ┌──                                                                                                                                                                                                                              │
│  │ ObjectID: 0xae7a90743074fb6214472491eae8ce75292317b1932126e94d87896c4748b49f                                                                                                                                                   │
│  │ Sender: 0xfc50aa2363f3b3c5d80631cae512ec51a8ba94080500a981f4ae1a2ce4d201c2                                                                                                                                                     │
│  │ Owner: Shared                                                                                                                                                                                                                  │
│  │ ObjectType: 0x1ea5b35865b62e25a1b3528260939282e819040563ee902716a3985b16b619c::token_pair::TokenPair<0x4bacff79c102805e6a1f0980456ecd5cd5e50dc155a90123de41e348e3ae07f0::example_coin::EXAMPLE_COIN, 0x2::sui::SUI>            │

│  ┌──                                                                                                                                                                                                                              │
│  │ ObjectID: 0xf12be45cc5f32e8a00fcaf527a88fd4176a0142bde63a3ed991651d8beaf05da                                                                                                                                                   │
│  │ Sender: 0xfc50aa2363f3b3c5d80631cae512ec51a8ba94080500a981f4ae1a2ce4d201c2                                                                                                                                                     │
│  │ Owner: Account Address ( 0xfc50aa2363f3b3c5d80631cae512ec51a8ba94080500a981f4ae1a2ce4d201c2 )                                                                                                                                  │
│  │ ObjectType: 0x1ea5b35865b62e25a1b3528260939282e819040563ee902716a3985b16b619c::liquidity_token::LiquidityToken<0x4bacff79c102805e6a1f0980456ecd5cd5e50dc155a90123de41e348e3ae07f0::example_coin::EXAMPLE_COIN, 0x2::sui::SUI>  │
```

### Withdraw token X reserve

Note the arguments required by `withdraw_x_reserve` function, which are assumed by the following commands:

* `token_pair: &mut TokenPair<X, Y>`: `0xae7a90743074fb6214472491eae8ce75292317b1932126e94d87896c4748b49f`.
* `liquidity_token: &LiquidityToken<X, Y>`: `0xf12be45cc5f32e8a00fcaf527a88fd4176a0142bde63a3ed991651d8beaf05da`.
* `x_amount: u64`: `1000`.
* `x_coin: &mut Coin<X>`: The ID of the test (`EXAMPLE_COIN`) coin object is `0xea38ba6edde8b115d4f2dd79afee9e71496bae7d583cad4143943c875c19f036`

Execute:

```shell
sui client call --package 0x01ea5b35865b62e25a1b3528260939282e819040563ee902716a3985b16b619c --module token_pair_service --function withdraw_x_reserve \
--type-args '0x4bacff79c102805e6a1f0980456ecd5cd5e50dc155a90123de41e348e3ae07f0::example_coin::EXAMPLE_COIN' '0x2::sui::SUI' \
--args \
'0xae7a90743074fb6214472491eae8ce75292317b1932126e94d87896c4748b49f' \
'0xf12be45cc5f32e8a00fcaf527a88fd4176a0142bde63a3ed991651d8beaf05da' \
'"1000"' \
'0xea38ba6edde8b115d4f2dd79afee9e71496bae7d583cad4143943c875c19f036' \
--gas-budget 30000000
```


### Withdraw token Y reserve

Assuming the SUI coin (token Y) object ID is `0x44e677e7fbfebef80d484eca63e350a1e8d9d5da4ab5a1e757d7e22a2d0a7b2c`.

Execute:

```shell
sui client call --package 0x01ea5b35865b62e25a1b3528260939282e819040563ee902716a3985b16b619c --module token_pair_service --function withdraw_y_reserve \
--type-args '0x4bacff79c102805e6a1f0980456ecd5cd5e50dc155a90123de41e348e3ae07f0::example_coin::EXAMPLE_COIN' '0x2::sui::SUI' \
--args \
'0xae7a90743074fb6214472491eae8ce75292317b1932126e94d87896c4748b49f' \
'0xf12be45cc5f32e8a00fcaf527a88fd4176a0142bde63a3ed991651d8beaf05da' \
'"555"' \
'0x44e677e7fbfebef80d484eca63e350a1e8d9d5da4ab5a1e757d7e22a2d0a7b2c' \
--gas-budget 30000000
```

### Deposit token Y reserve

Replenish the token Y reserve, execute:

```shell
sui client call --package 0x01ea5b35865b62e25a1b3528260939282e819040563ee902716a3985b16b619c --module token_pair_service --function deposit_y_reserve \
--type-args '0x4bacff79c102805e6a1f0980456ecd5cd5e50dc155a90123de41e348e3ae07f0::example_coin::EXAMPLE_COIN' '0x2::sui::SUI' \
--args \
'0xae7a90743074fb6214472491eae8ce75292317b1932126e94d87896c4748b49f' \
'0x44e677e7fbfebef80d484eca63e350a1e8d9d5da4ab5a1e757d7e22a2d0a7b2c' \
'"555"' \
--gas-budget 30000000
```

### Swap tokens

Swap, to exchange Token X for Token Y. Note the parameters of this function:

* `token_pair: &mut TokenPair<X, Y>`.
* `x_coin: Coin<X>`: The ID of the test (`EXAMPLE_COIN`) coin object is `0xea38ba6edde8b115d4f2dd79afee9e71496bae7d583cad4143943c875c19f036`.
* `x_amount: u64`: `10000`.
* `y_coin: &mut Coin<Y>`: Assuming the SUI coin object ID is `0x44e677e7fbfebef80d484eca63e350a1e8d9d5da4ab5a1e757d7e22a2d0a7b2c`.

Execute:

```shell
sui client call --package 0x01ea5b35865b62e25a1b3528260939282e819040563ee902716a3985b16b619c --module token_pair_service --function swap_x \
--type-args '0x4bacff79c102805e6a1f0980456ecd5cd5e50dc155a90123de41e348e3ae07f0::example_coin::EXAMPLE_COIN' '0x2::sui::SUI' \
--args \
'0xae7a90743074fb6214472491eae8ce75292317b1932126e94d87896c4748b49f' \
'0xea38ba6edde8b115d4f2dd79afee9e71496bae7d583cad4143943c875c19f036' \
'"10000"' \
'0x44e677e7fbfebef80d484eca63e350a1e8d9d5da4ab5a1e757d7e22a2d0a7b2c' \
--gas-budget 30000000
```


### Test off-chain service

#### Configuring off-chain Service

Open the `application-test.yml` file located in the directory `sui-java-service/suiswapexample-service-rest/src/main/resources` and set the published transaction digest.

After setting, it should look like this:

```yaml
sui:
  contract:
    jsonrpc:
      url: "https://fullnode.devnet.sui.io/"
    package-publish-transaction: "267z86Ge4Phdow8AH424uw9WPqBhrGSUbjMsuA6cpEzp"
```

This is the only place where off-chain service need to be configured, and it's that simple.


#### Creating a database for off-chain service

Use a MySQL client to connect to the local MySQL server and execute the following script to create an empty database (assuming the name is `test5`):

```sql
CREATE SCHEMA `test5` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;
```

Go to the `sui-java-service` directory and package the Java project:

```shell
mvn package
```

Then, run a command-line tool to initialize the database:

```shell
java -jar ./suiswapexample-service-cli/target/suiswapexample-service-cli-0.0.1-SNAPSHOT.jar ddl -d "./scripts" -c "jdbc:mysql://127.0.0.1:3306/test5?enabledTLSProtocols=TLSv1.2&characterEncoding=utf8&serverTimezone=GMT%2b0&useLegacyDatetimeCode=false" -u root -p 123456
```

#### Starting off-chain Service

In the `sui-java-service` directory, run the following command to start the off-chain service:

```shell
mvn -pl suiswapexample-service-rest -am spring-boot:run
```


##  Further Reading

### Sui Crowdfunding Example

Another Sui Move sample project for teaching purposes. Repository: https://github.com/dddappp/sui-crowdfunding-example

You can refer to its README to refine the business logic of this project, as well as to test the application.

### Sui Blog Example

Repository: https://github.com/dddappp/sui-blog-example

It only requires 30 or so lines of code (all of which is a description of the domain model) to be written by the developer, and then generates a blog example that emulates [RoR Getting Started](https://guides.rubyonrails.org/getting_started.html) in one click, without requiring the developer to write a single line of other code.


### A More Complex Sui Demo

If you are interested, you can find a more complex Sui Demo here: ["A Sui Demo"](https://github.com/dddappp/A-Sui-Demo).


### Rooch Blog Example

Here is a Rooch version like above Sui blog example: https://github.com/rooch-network/rooch/blob/main/examples/blog/README.md

