# Flex： 一个在 Sui 上的 NFT 交易平台

注意：本文的中文版本比较相对英文版本 [README.md](./README.md) 要简略，更详细信息请参考英文版本。

## 需求

[TBD]

## 前置条件

[TBD]

## 开发前置条件

## 编码

### 编写 DDDML 模型文件

### 运行项目 dddappp 创建工具

### 实现业务逻辑

对于链上合约部分，工具为我们创建了大量的 Move 代码，凡是以注释 `// <autogenerated>` 开头的代码，我们不应该修改它们。

实现业务逻辑代码的工作，主要是在那些后缀为 `_logic.move` 的文件中进行。

## 测试应用

### 一些可能需要的准备工作

#### 准备 SUI coin 对象

查看当前账户中的 SUI Coin 对象：

```shell
sui client gas
```

如果你的账户只有一个 Sui Coin 对象，可以先给自己的账户转一些 SUI，以达到 split 这个 Sui Coin 对象的目的。
下面的测试中，我们除了需要使用一个 Sui Coin 对象来付 gas 费之外，还需要使用一个 Sui Coin 对象来添加流动性：

```shell
sui client pay-sui --input-coins 0x4715b65812e202a97f47f7dddf288776fabae989d1288c2e17c616c566abc294 --amounts 1000000000 \
--recipients 0xfc50aa2363f3b3c5d80631cae512ec51a8ba94080500a981f4ae1a2ce4d201c2 --gas-budget 30000000
```

#### Mint 一些 Movescription 代币

我们已经在 testnet 上部署了一个 movescription 测试合约，它的 package ID：`0xf4090a30c92074412c3004906c3c3e14a9d353ad84008ac2c23ae402ee80a6ff`。

测试铭文 `MOVE` 的 `TickRecord` 的对象 ID：`0x34fccc1a953d02f3a7ddbd546e7982aff89c6989c8181d34e788bd855cb6ff64`。

注意使用 Sui CLI 测试时，先切换环境到 testnet：

```shell
sui client switch --env testnet
```

Mint 一些 `MOVE` 测试铭文（每次 mint 请间隔一分钟），注意，第三个参数，也就是下面示例的 `0x44e677e7fbfebef80d484eca63e350a1e8d9d5da4ab5a1e757d7e22a2d0a7b2c` 
应该改为你的一个 SUI Coin 对象的 Id。

```shell
sui client call --package 0xf4090a30c92074412c3004906c3c3e14a9d353ad84008ac2c23ae402ee80a6ff --module movescription --function mint --args 0x34fccc1a953d02f3a7ddbd546e7982aff89c6989c8181d34e788bd855cb6ff64 \"MOVE\" 0x44e677e7fbfebef80d484eca63e350a1e8d9d5da4ab5a1e757d7e22a2d0a7b2c \"0x6\" --gas-budget 19000000
```

Split 一个铭文：

```shell
sui client call --package 0xf4090a30c92074412c3004906c3c3e14a9d353ad84008ac2c23ae402ee80a6ff --module movescription --function split --args  0xfc8debdede996da1901ec9090ac8d6cda8478705f6c8bad64056b540ff6b4f8c '"1000"' --gas-budget 19000000
```


### 部署合约

执行以下命令部署合约：

```shell
sui client publish --gas-budget 1000000000 --skip-fetch-latest-git-deps
```

如果命令执行成功，在终端中会输出这次发布的交易摘要。比如：

```*shell
*----- Transaction Digest ----
267z86Ge4Phdow8AH424uw9WPqBhrGSUbjMsuA6cpEzp
----- Transaction Data ----
#...
```

记录下这个交易摘要，比如 `267z86Ge4Phdow8AH424uw9WPqBhrGSUbjMsuA6cpEzp`。
在设置链下服务的时候，我们需要用到它。


### 初始化流动性

[TBD]

### 添加流动性

[TBD]

### 移除流动性

[TBD]

### 兑换

[TBD]

### 测试链下服务

### 链下服务 API

我们的链下服务将链上的对象状态拉取到链下的 SQL 数据库，以提供查询功能。

我们当然可以先使用 Sui 官方提供的 API 服务，见：https://docs.sui.io/references/sui-api 
但是，有些应用特定的查询需求，Sui 官方的 API 服务可能并不能满足，所以，很多应有都有必要自己搭建或者使用第三方提供的增强的查询或检索服务。 

默认情况下，我们生成的链下服务提供了一些开箱即用的 API。比如：

获取代币对列表：

```text
http://localhost:1023/api/TokenPairs
```

你甚至可以使用查询条件：

```text
http://localhost:1023/api/TokenPairs?totalLiquidity=gt(100)&x_Reserve.tick=MOVE
```

获取某个代币的信息：

```text
http://localhost:1023/api/TokenPairs/0xe5bb0aa9fcd7ce57973bd3289f5b1ab0f946c47f3273641c3527a5d26775a5ac
```

获取流动性 Token 的列表：

```text
http://localhost:1023/api/LiquidityTokens
```

获取某个流动性 Token 的信息：

```text
http://localhost:1023/api/LiquidityTokens/0x1c934038fbb356446add349062e9fad959820c5998c80f6f363969d07288cb16
```

#### 获取列表的查询参数

可以在获取列表的请求 URL 中支持的查询参数，包括：

* sort：用于排序的属性名称。多个属性名称可以英文逗号分隔。属性名称前面有“-”则表示倒序排列。
    查询参数 `sort` 还可以多次出现，像这样：`sort=fisrtName&sort=lastName,desc`。
* fields：需要返回的字段（属性）名称。多个名称可以逗号分隔。
* filter：返回结果的过滤器，后文会进一步解释。
* firstResult：返回结果中第一条记录的序号，从 0 开始计算。
* maxResults：返回结果的最大记录数量。

#### 获取列表的 Page 封包

虽然我个人并不喜欢“封包”，但是因为有些开发人员强烈要求，我们还是支持发送 GET 请求到这个 URL 以获取的列表的 Page（分页）封包：

```url
{BASE_URL}/{Entities}/_page?page={page}
```

支持的分页相关的查询参数：

* page：获取第几页（从 0 开始）。
* size：Page size。

比如：

```text
http://localhost:1023/api/TokenPairs/_page?page=0&size=10
```

#### 还需要更多的查询功能？

由于链下服务已经将链上的对象状态拉取到链下的 SQL 数据库，所以，我们可以使用任意 SQL 查询语句来查询链下服务的数据库。
将这些 SQL 查询语句封装成 API，是非常容易的事情。如果你有这样的需求，修改源代码，添加你需要的 API 即可。


